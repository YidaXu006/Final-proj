(* ====================== 任务一：阻尼振动的完整分析 ====================== *)
(* 彻底清空所有变量，包括内置符号缓存，避免任何冲突 *)
Clear["Global`*"];  

(* ====================== 1. 解析解求解  ====================== *)
(* -------------------- 1.1 求解通解（严格遵循DSolve语法：{方程}, 未知函数, 变量） -------------------- *)
(* 定义符号参数与微分方程（m=1, k=1 先保留符号，后续赋值） *)
With[{m = 1, k = 1},
  eqGeneral = m*D[x[t], {t, 2}] + γ*D[x[t], t] + k*x[t] == 0;
];
(* 求解通解：DSolve[ {方程}, 未知函数, 自变量 ] *)
generalSolution = DSolve[eqGeneral, x[t], t];
Print["阻尼谐振子方程的通解："];
Print[generalSolution // Simplify];
Print["--------------------------------------------------"];

(* -------------------- 1.2 三种阻尼的特解（修正DSolve参数+变量作用域） -------------------- *)
(* 固定参数与初始条件（严格格式：{x[0]==1, x'[0]==0}） *)
m = 1; k = 1;
initConditions = {x[0] == 1, Derivative[1][x][0] == 0};
(* 三种阻尼系数：欠阻尼、临界阻尼、过阻尼 *)
dampingCoeffs = {0.2, 2, 4};
(* 初始化特解列表（确保为可修改的空列表） *)
specificSolutions = {};

(* 遍历求解每种阻尼的特解（逐行校验语法） *)
Do[
  (* 赋值当前阻尼系数，避免全局γ污染 *)
  γVal = dampingCoeffs[[i]];
  (* 构建当前阻尼下的微分方程（显式代入γ值） *)
  eqSpecific = m*D[x[t], {t, 2}] + γVal*D[x[t], t] + k*x[t] == 0;
  (* DSolve核心修正：第一个参数必须是 {方程, 初始条件} 列表 *)
  sol = DSolve[{eqSpecific, initConditions}, x[t], t];
  (* 仅当求解成功时追加到列表（避免空解） *)
  If[sol =!= {},
    AppendTo[specificSolutions, First[sol]];
    (* 输出特解标注（Switch语法严格匹配） *)
    Print[Switch[i,
      1, "欠阻尼（γ=0.2）特解：",
      2, "临界阻尼（γ=2）特解：",
      3, "过阻尼（γ=4）特解："]];
    Print[First[sol] // Simplify];
  ];
  Print["--------------------------------------------------"];
, {i, 1, Length[dampingCoeffs]}];

(* ====================== 2. 可视化比较  ====================== *)
(* -------------------- 2.1 同图绘制x(t)曲线（修正Plot参数+容错） -------------------- *)
(* 提取位移表达式（容错：列表长度不足时返回0，避免索引报错） *)
x1 = If[Length[specificSolutions] >= 1, x[t] /. specificSolutions[[1]], 0];
x2 = If[Length[specificSolutions] >= 2, x[t] /. specificSolutions[[2]], 0];
x3 = If[Length[specificSolutions] >= 3, x[t] /. specificSolutions[[3]], 0];

(* 绘制x(t)曲线（严格Plot语法，避免Pattern报错） *)
plotXT = Plot[
  Evaluate[{x1, x2, x3}],  (* Evaluate确保表达式先求值 *)
  {t, 0, 15},
  PlotLabel -> "三种阻尼的x(t)曲线（t∈[0,15]）",
  AxesLabel -> {"时间 t", "位移 x(t)"},
  PlotLegends -> {"欠阻尼 (γ=0.2)", "临界阻尼 (γ=2)", "过阻尼 (γ=4)"},
  PlotStyle -> {{Red, Thick}, {Blue, Thick}, {Green, Thick}},
  BaseStyle -> FontSize -> 10,
  PlotRange -> All
];
Print["三种阻尼的x(t)位移曲线："];
Show[plotXT];
Print["--------------------------------------------------"];

(* -------------------- 2.2 相空间轨迹（修正ParametricPlot+Show合并） -------------------- *)
(* 计算速度（位移的一阶导数） *)
v1 = D[x1, t]; v2 = D[x2, t]; v3 = D[x3, t];

(* 绘制相空间轨迹（避免DisplayFunction冲突，直接绘制后合并） *)
plotPhase1 = ParametricPlot[Evaluate[{x1, v1}], {t, 0, 15}, PlotStyle -> {Red, Thick}];
plotPhase2 = ParametricPlot[Evaluate[{x2, v2}], {t, 0, 15}, PlotStyle -> {Blue, Thick}];
plotPhase3 = ParametricPlot[Evaluate[{x3, v3}], {t, 0, 15}, PlotStyle -> {Green, Thick}];

(* 合并相空间图（修正Show参数，避免Times被保护报错） *)
plotPhaseAll = Show[
  {plotPhase1, plotPhase2, plotPhase3},
  PlotLabel -> "三种阻尼的相空间轨迹 (x, ẋ)",
  AxesLabel -> {"位移 x", "速度 ẋ"},
  BaseStyle -> FontSize -> 10,
  PlotRange -> All,
  AspectRatio -> 1,
  PlotLegends -> {"欠阻尼 (γ=0.2)", "临界阻尼 (γ=2)", "过阻尼 (γ=4)"}
];
Print["三种阻尼的相空间轨迹图："];
Show[plotPhaseAll];



(* ====================== 任务二 ====================== *)
Clear["Global`*"];  (* 清空所有全局变量，避免符号冲突 *)

(* ====================== 1. 稳态响应分析  ====================== *)
(* -------------------- 1.1 设定参数与稳态振幅公式推导 -------------------- *)
(* 固定系统参数：m=1, k=1, γ=0.2, F0=1 *)
m = 1; k = 1; γ = 0.2; F0 = 1;
(* 受迫振动稳态振幅公式：A(ω) = F0 / √[(k - mω²)² + (γω)²] *)
amplitudeA[ω_] = F0 / Sqrt[(k - m*ω^2)^2 + (γ*ω)^2];

(* 输出稳态振幅函数表达式 *)
Print["稳态振幅 A(ω) 的表达式："];
Print[amplitudeA[ω] // Simplify];
Print["--------------------------------------------------"];

(* -------------------- 1.2 求解共振频率与最大振幅 -------------------- *)
(* 共振频率：振幅取最大值时的ω（求导并令导数为0） *)
dA = D[amplitudeA[ω], ω];  (* 对振幅求导 *)
resonanceFreq = NSolve[dA == 0 && ω > 0, ω][[1, 1, 2]];  (* 求解正频率解 *)
maxAmplitude = amplitudeA[resonanceFreq];  (* 计算最大振幅 *)

(* 输出共振频率与最大振幅 *)
Print["共振频率 ω_res = ", resonanceFreq // N];
Print["最大振幅 A_max = ", maxAmplitude // N];
Print["--------------------------------------------------"];

(* -------------------- 1.3 绘制振幅-频率响应曲线（共振曲线） -------------------- *)
resonancePlot = Plot[
    amplitudeA[ω],
    {ω, 0, 3},  (* 频率范围ω∈[0,3] *)
    PlotLabel -> "受迫振动振幅-频率响应曲线（共振曲线）",
    AxesLabel -> {"驱动频率 ω", "稳态振幅 A(ω)"},
    PlotStyle -> {Blue, Thick},
    BaseStyle -> FontSize -> 10,
    PlotRange -> All,
    (* 标注共振频率和最大振幅 *)
    Epilog -> {
        Red, PointSize[0.02], Point[{resonanceFreq, maxAmplitude}],  (* 共振点 *)
        Text["共振点 (ω=" <> ToString[Round[resonanceFreq, 0.01]] <> ", A=" <> ToString[Round[maxAmplitude, 0.01]] <> ")", 
             {resonanceFreq + 0.1, maxAmplitude}, {0, 0}],  (* 标注文本 *)
        Dashed, Line[{{resonanceFreq, 0}, {resonanceFreq, maxAmplitude}}],  (* 竖线标注共振频率 *)
        Dashed, Line[{{0, maxAmplitude}, {resonanceFreq, maxAmplitude}}]   (* 横线标注最大振幅 *)
    }
];
Print["振幅-频率响应曲线（共振曲线）："];
Show[resonancePlot];
Print["--------------------------------------------------"];

(* ====================== 2. 数值求解与瞬态-稳态过渡分析  ====================== *)
(* -------------------- 2.1 定义受迫振动微分方程（含初始条件） -------------------- *)
(* 微分方程：m x''[t] + γ x'[t] + k x[t] = F0 Cos[ω t] *)
forcedOscEq[ω_] := m*D[x[t], {t, 2}] + γ*D[x[t], t] + k*x[t] == F0*Cos[ω*t];
(* 初始条件：x(0)=0, x'(0)=0 *)
initCond = {x[0] == 0, Derivative[1][x][0] == 0};

(* -------------------- 2.2 遍历求解不同ω的数值解（ω=0.5,1.0,1.5） -------------------- *)
ωList = {0.5, 1.0, 1.5};  (* 待求解的驱动频率 *)
solList = {};  (* 存储数值解 *)

(* 用NDSolve求解初值问题 *)
Do[
    ωVal = ωList[[i]];
    (* NDSolve求解数值解：t∈[0, 50]（足够长以观察稳态） *)
    sol = NDSolve[{forcedOscEq[ωVal], initCond}, x[t], {t, 0, 50}];
    AppendTo[solList, sol[[1]]];
    Print["ω=", ωVal, " 时的数值解求解完成"];
, {i, 1, Length[ωList]}];

(* -------------------- 2.3 绘制不同ω下的x(t)曲线，观察过渡过程 -------------------- *)
(* 提取x(t)表达式 *)
x1 = x[t] /. solList[[1]];  (* ω=0.5 *)
x2 = x[t] /. solList[[2]];  (* ω=1.0 *)
x3 = x[t] /. solList[[3]];  (* ω=1.5 *)

(* 绘制x(t)曲线对比 *)
transientPlot = Plot[
    Evaluate[{x1, x2, x3}],
    {t, 0, 50},  (* 时间范围t∈[0,50]，覆盖瞬态到稳态 *)
    PlotLabel -> "受迫振动x(t)曲线（不同驱动频率）",
    AxesLabel -> {"时间 t", "位移 x(t)"},
    PlotLegends -> {"ω=0.5", "ω=1.0（近共振）", "ω=1.5"},
    PlotStyle -> {
        {RGBColor[1, 0, 0], Thick},    (* ω=0.5：红色 *)
        {RGBColor[0, 0, 1], Thick},   (* ω=1.0：蓝色 *)
        {RGBColor[0, 0.8, 0], Thick}  (* ω=1.5：绿色 *)
    },
    BaseStyle -> FontSize -> 10,
    PlotRange -> All
];
Print["不同驱动频率下的x(t)曲线（瞬态→稳态）："];
Show[transientPlot];